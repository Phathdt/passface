# Deployment Guide: Vercel + PostgreSQL

This guide shows you how to deploy the Passkey Authentication MVP to Vercel with a PostgreSQL database.

## Prerequisites

- Vercel account (free tier works)
- GitHub account
- Git installed locally

## Option 1: Vercel PostgreSQL (Recommended for Testing)

Vercel offers a built-in PostgreSQL database that's perfect for testing.

### Step 1: Install Vercel CLI

```bash
pnpm add -g vercel
```

### Step 2: Login to Vercel

```bash
vercel login
```

### Step 3: Link Your Project

```bash
vercel link
```

Follow the prompts:

- Set up and deploy? **Y**
- Scope? Select your account
- Link to existing project? **N**
- Project name? **passface** (or your preferred name)
- Directory? **./** (current directory)

### Step 4: Create PostgreSQL Database

1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Navigate to **Storage** tab
3. Click **Create Database**
4. Select **Postgres**
5. Name it: `passface-db`
6. Region: Choose closest to you (e.g., `Singapore (sin1)`)
7. Click **Create**

### Step 5: Connect Database to Project

1. In Vercel Dashboard, go to your project
2. Go to **Settings** → **Environment Variables**
3. Vercel will auto-populate `POSTGRES_*` variables
4. Add these additional variables:

```bash
# Database URL (auto-generated by Vercel)
DATABASE_URL="${POSTGRES_PRISMA_URL}"

# WebAuthn Configuration
NEXT_PUBLIC_RP_ID="your-app.vercel.app"
NEXT_PUBLIC_ORIGIN="https://your-app.vercel.app"
```

**Important:** Replace `your-app` with your actual Vercel app name.

### Step 6: Update Prisma for Vercel Postgres

Vercel Postgres requires connection pooling. Update your schema:

```prisma
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")  // For migrations
}
```

### Step 7: Deploy

```bash
# Deploy to production
vercel --prod

# Vercel will automatically:
# 1. Install dependencies
# 2. Run prisma generate
# 3. Build Next.js app
# 4. Deploy
```

### Step 8: Run Migrations

After first deployment:

```bash
# Pull environment variables locally
vercel env pull .env.production

# Run migration
DATABASE_URL=$(grep POSTGRES_PRISMA_URL .env.production | cut -d '=' -f2-) npx prisma migrate deploy

# Or connect to Vercel and run:
vercel env pull
npx prisma migrate deploy
```

---

## Option 2: External PostgreSQL (Neon, Supabase, Railway)

### Using Neon (Serverless PostgreSQL)

Neon offers a generous free tier with serverless PostgreSQL.

#### Step 1: Create Neon Account

1. Go to [Neon](https://neon.tech)
2. Sign up (free)
3. Create new project: `passface`
4. Select region closest to your users

#### Step 2: Get Connection String

Neon provides two connection strings:

```bash
# For Prisma migrations (direct connection)
DIRECT_URL="postgresql://user:pass@ep-xxx.us-east-2.aws.neon.tech/passface"

# For Prisma Client (pooled connection)
DATABASE_URL="postgresql://user:pass@ep-xxx-pooler.us-east-2.aws.neon.tech/passface?sslmode=require"
```

#### Step 3: Add to Vercel Environment Variables

1. Go to Vercel Dashboard → Your Project → Settings → Environment Variables
2. Add:

```bash
DATABASE_URL="postgresql://user:pass@ep-xxx-pooler.us-east-2.aws.neon.tech/passface?sslmode=require"
DIRECT_URL="postgresql://user:pass@ep-xxx.us-east-2.aws.neon.tech/passface"
NEXT_PUBLIC_RP_ID="your-app.vercel.app"
NEXT_PUBLIC_ORIGIN="https://your-app.vercel.app"
```

#### Step 4: Update Prisma Schema

```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
```

#### Step 5: Deploy

```bash
vercel --prod
```

### Using Supabase

Similar process:

1. Create project at [Supabase](https://supabase.com)
2. Get connection string from Settings → Database
3. Use the **connection pooling** URL for `DATABASE_URL`
4. Use the **direct connection** URL for `DIRECT_URL`

### Using Railway

1. Create project at [Railway](https://railway.app)
2. Add PostgreSQL plugin
3. Copy connection URL
4. Add to Vercel environment variables

---

## Deployment Checklist

### Pre-Deployment

- [ ] Update `.env.example` with production placeholders
- [ ] Add `.vercelignore` to exclude unnecessary files
- [ ] Test build locally: `pnpm build`
- [ ] Verify PostgreSQL connection works
- [ ] Update `NEXT_PUBLIC_RP_ID` in code

### Post-Deployment

- [ ] Run database migrations
- [ ] Test passkey registration on production URL
- [ ] Test passkey authentication
- [ ] Test message signing
- [ ] Verify signatures are deterministic
- [ ] Test CORS and security headers

---

## Important Configuration Changes for Production

### 1. Update WebAuthn Config

```typescript
// src/lib/auth/webauthn-config.ts
export const webAuthnConfig = {
  rpID: process.env.NEXT_PUBLIC_RP_ID || 'localhost',
  rpName: 'Passface',
  origin: process.env.NEXT_PUBLIC_ORIGIN || 'http://localhost:3000',
}
```

### 2. Add Security Headers

Create `next.config.ts`:

```typescript
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin',
          },
          {
            key: 'Permissions-Policy',
            value: 'publickey-credentials-get=(self)',
          },
        ],
      },
    ]
  },
}

export default nextConfig
```

### 3. Update CORS for API Routes

```typescript
// Add to API routes if needed
const headers = {
  'Access-Control-Allow-Origin': process.env.NEXT_PUBLIC_ORIGIN || '*',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type',
}
```

---

## Testing in Production

### Test Script

```javascript
// Run in browser console on your-app.vercel.app

// 1. Test Registration
console.log('Testing registration...')
// Use the UI to register

// 2. Test Signing
console.log('Testing message signing...')
const message = 'Test from production'
// Use the UI to sign

// 3. Test Cross-Device (if using Google/iCloud sync)
console.log('Test on another device with same account')
```

### Verify Database

```bash
# Connect to production database
vercel env pull
psql $DATABASE_URL

# Check tables
\dt

# Check users
SELECT * FROM "User";

# Check credentials
SELECT * FROM "Credential";
```

---

## Troubleshooting

### Issue: "Unable to connect to database"

**Solution:**

```bash
# Check DATABASE_URL is set in Vercel
vercel env ls

# Verify Prisma Client is generated
# Add to package.json:
{
  "scripts": {
    "vercel-build": "prisma generate && next build"
  }
}
```

### Issue: "Passkey not working on production"

**Solution:**

1. Check `NEXT_PUBLIC_RP_ID` matches your domain
2. Ensure using HTTPS (required for WebAuthn)
3. Check browser console for errors
4. Verify origin in webauthn-config.ts

### Issue: "Migration failed"

**Solution:**

```bash
# Reset migrations (WARNING: deletes data)
npx prisma migrate reset

# Or apply migrations manually
npx prisma migrate deploy
```

### Issue: "Different signatures on production"

**Solution:**

- Check credentialId is consistent
- Verify userId is same across sessions
- Check for timezone/encoding issues

---

## Environment Variables Reference

### Required for Production

```bash
# Database
DATABASE_URL="postgresql://..."
DIRECT_URL="postgresql://..."  # For migrations

# WebAuthn
NEXT_PUBLIC_RP_ID="your-app.vercel.app"
NEXT_PUBLIC_ORIGIN="https://your-app.vercel.app"
```

### Optional

```bash
# Node Environment
NODE_ENV="production"

# Logging
LOG_LEVEL="info"
```

---

## Cost Estimation

### Vercel Free Tier

- ✅ Hosting: Free
- ✅ Serverless Functions: 100GB-hours/month
- ✅ Bandwidth: 100GB/month
- ⚠️ PostgreSQL: $0.02/hour ($14.40/month) after free trial

### Neon Free Tier

- ✅ 0.5 GB storage
- ✅ Unlimited compute hours (with autosuspend)
- ✅ Free forever

### Supabase Free Tier

- ✅ 500 MB database
- ✅ 1 GB file storage
- ✅ 2 GB bandwidth/month
- ✅ Free forever

**Recommendation for MVP:** Vercel + Neon (both free tiers = $0/month)

---

## Post-Deployment Steps

### 1. Set Up Monitoring

Add to `package.json`:

```json
{
  "scripts": {
    "monitor": "vercel logs --follow"
  }
}
```

### 2. Enable Analytics

Vercel automatically provides:

- Web Analytics
- Speed Insights
- Error tracking

Enable in Vercel Dashboard → Analytics

### 3. Set Up Custom Domain (Optional)

1. Go to Vercel Dashboard → Settings → Domains
2. Add your domain: `passface.yourdomain.com`
3. Update DNS records as instructed
4. Update environment variables with new domain

---

## Quick Deploy Commands

```bash
# 1. Initial setup
vercel login
vercel link

# 2. Deploy to preview
vercel

# 3. Deploy to production
vercel --prod

# 4. View logs
vercel logs --follow

# 5. Pull environment variables
vercel env pull

# 6. Run migrations
npx prisma migrate deploy
```

---

## Security Checklist for Production

- [ ] Enable HTTPS (automatic on Vercel)
- [ ] Set strong DATABASE_URL password
- [ ] Enable database SSL (required for Vercel/Neon)
- [ ] Add rate limiting to API routes
- [ ] Enable CSRF protection
- [ ] Set up error monitoring
- [ ] Regular security updates
- [ ] Database backups enabled
- [ ] Environment variables not in code
- [ ] `.env` files in `.gitignore`

---

## Next Steps After Deployment

1. **Test Cross-Device Signing**
   - Register on desktop
   - Test on mobile
   - Verify same signatures

2. **Monitor Performance**
   - Check Vercel Analytics
   - Monitor database query performance
   - Optimize if needed

3. **Add Features**
   - Multiple credentials support
   - Credential management UI
   - Signature history
   - Export/import functionality

4. **Documentation**
   - API documentation
   - User guide
   - Security best practices

---

## Support

- **Vercel Docs:** https://vercel.com/docs
- **Neon Docs:** https://neon.tech/docs
- **Prisma Docs:** https://www.prisma.io/docs
- **WebAuthn Guide:** https://webauthn.guide

---

## Example Production URLs

After deployment, your app will be available at:

```
Preview: https://passface-git-main-yourusername.vercel.app
Production: https://passface.vercel.app
Custom: https://passface.yourdomain.com
```

Test with:

1. Open production URL
2. Register with passkey
3. Sign a message
4. Verify signature matches on re-login
